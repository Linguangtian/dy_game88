<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="renderer" content="webkit" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <title>{if $share['nickname']}{$share['nickname']}的{if $bl['fzname']}{$bl['fzname']}{else}分站{/if}{/if}{$views['itemtitle']}</title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="{$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/pdd/css/m-cui.css" />
    <link rel="stylesheet" href="{$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/pdd/css/m-lib.css" />
    <link rel="stylesheet" href="{$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/pdd/css/style.css" />
    <script src="{$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/style9/js/jweixin-1.0.0.js"></script>
</head>
<script>

        var appid = "{$_W['account']['jssdkconfig']['appId']}";
        var timestamp = "{$_W['account']['jssdkconfig']['timestamp']}";
        var nonceStr = "{$_W['account']['jssdkconfig']['nonceStr']}";
        var signature = "{$_W['account']['jssdkconfig']['signature']}";
        wx.config({
            debug: false,
            appId: appid,
            timestamp: timestamp,
            nonceStr: nonceStr,
            signature: signature,
            jsApiList: [
                "onMenuShareAppMessage",
                "onMenuShareTimeline",
                "chooseImage",
                "uploadImage",
                "downloadImage"
            ]
        });

	wx.ready(function(){

//		wx.hideOptionMenu();
		wx.onMenuShareAppMessage({
			title: "【券后价：{$views['itemendprice']}元】 {$views['itemtitle']}",
			desc: "{$views['title']}",
			link: window.location.href ,
			imgUrl: "{$views['itempic5'][0]}"
		}); 
		wx.onMenuShareTimeline({
			title: "【券后价：{$views['itemendprice']}元】 {$views['itemtitle']}",
			desc: "{$views['title']}",
			link: window.location.href,
			imgUrl: "{$views['itempic5'][0]}"
		});
	});
</script>
<body style="padding-top:0">
    <!--<div class="header-n">
        <a href="" class="a-back"></a>
        <h2 class="h-tit">详情页</h2>
    </div>-->
    <div class="main">
        <div class="good-item">
            <div class="good-top">
                <div class="swiper-container">
                    <div class="swiper-wrapper">
                    	{loop $views['itempic5'] $v}
                        <div class="swiper-slide">
                            <a href="" class="pic"><img src="{$v}" alt=""></a>
                        </div>
                        {/loop}

                    </div>
                    <div class="swiper-pagination"></div>
                </div>
                <a href="javascript:void(0);" onclick="history.go(-1);" class="a-home"><img src="{$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/style99/imgs/zys_img19.png"</a>
                <!--<div class="r-share">
                    <a href="" class="share1">
                        <em></em>生成分享图
                    </a>
                    <a href="" class="share2">
                        <em></em>转发给好友
                    </a>
                </div>-->
                {if $views['yj']}
                <a href="" class="j-num">奖{$views['yj']}</a>
                {/if}
            </div>
            <div class="good-txt">
                <h5><a href=""><em></em>  {$views['itemtitle']}</a></h5>
                <div class="price">
                    <span class="team-num">已拼{$views['itemsale']}人</span>
                    <i>券后价</i>￥<b>{$views['itemendprice']}</b><em>￥{$views['itemprice']}</em>
                </div>
                <div class="quan">
                    <a href="{$views['url1']}">
                        <span class="sp1">
                        	{if $views['couponmoney']}
                            <em class="em1">{$views['couponmoney']}元优惠券</em>
                            <em class="date">使用期限：{$views['coupon_end_time']}</em>
                            {else}
                            <em class="em1">暂无优惠券</em>
                            {/if}
                            
                        </span>
                        <span class="sp2">立即领券 </span>
                    </a>
                </div>
                {if $views['itemdesc']}
                <p><span>推荐：</span>{$views['itemdesc']}</p>
                {/if}
            </div>
        </div>
        <div class="pic-info" style="line-height: 50px;padding-bottom: 100px;">
            <h5>图文详情</h5>
            <div id="cententview"></div>
        </div>
        <div class="f-shop">
            <div class="a-box">
                <a href='{php echo $this->createMobileUrl("pddgoodslist",array("key"=>$views["itemtitle"]))}' class="a1">搜索同款</a>
                <a href="{$views['url1']}" class="a2">领券拼购</a>
            </div>   
            <div class="item-box">
                <a href="{php echo $this->createMobileUrl('index')}" class="item on">
                    <em class="em1"></em>
                    <h5>首页</h5>
                </a>
                <a href="javascript:void(0);" id="cus_service" class="item">
                    <em class="em2"></em>
                    <h5>客服</h5> 
                </a>
                <a href="javascript:void(0);" id="open_fullimg_btn" class="item">
                    <em class="em3"></em>
                    <h5>海报</h5> 
                </a>
            </div>
        </div>
    </div>
    <!--海报-->
    <canvas id="sharecanvas" style="background-color:white; width:80%;display: none;" class="am-text-center am-center"></canvas>
    <!--<div class="mask" id="mask" style="display: none;">				
	</div>
	<div class="full_img" id="full_img" style="display: none;top:85px">
		<p id="rwmtp"></p>
		<a href="###" class="fullimg_close" id="fullimg_close"></a>
	</div>-->
	<!-- 海报弹窗 -->
    <div class="poster-pop" style="display: none;" id="mask"  >
        <div class="cont"  id="full_img">
        	<p id="rwmtp"></p>
            <!-- 测试可删除 -->
            <!-- 测试可删除-end -->

            <!-- 内容区 -->

            <!-- 内容区-end -->
            
            <span class="close" id="fullimg_close"></span>
        </div>
    </div>
    <!-- 海报弹窗-end -->
    <!--结束-->
    <!--客服-->
    <div class="mask" id="mask" style="display: none;">
	</div>
	<div class="full_img" id="full_img" style="display: none;top:85px">
		<p id="rwmtp"></p>
		<a href="###" class="fullimg_close" id="fullimg_close"></a>
	</div>
	<div class="cus_service_img" id="cus_service_img" style="display: none;">
		<img src="{php echo tomedia($cfg['kfewm'])}"/>
	</div>
    <!--结束-->
    <style>
    	.mask {
    position: fixed;
    left: 50%;
    margin-left: -360px;
    top: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    width: 720px;
    z-index: 99;
}
.full_img{
	position: fixed;
	z-index: 999;
	top: 140px;
	left: 50%;
	margin-left: -245px;
	width: 490px;
	height: 655px;
	/*text-align: center;*/
}
.full_img img{
	width: 490px;
	height: 700px;
}
.fullimg_close{
	position: absolute;
	right: -17;
	top: -17;
	display: inline-block;
	width: 34px;
	height: 34px;
	background: url({$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/style99/imgs/zys_img64.png) no-repeat;
	background-position: center;
}
.cus_service_img{
	position: fixed;
    z-index: 9999;
    top: 50%;
    left: 50%;
    margin-left: -129px;
    margin-top: -129px;
    width: 258px;
    height: 258px;
}
.cus_service_img img{
	width: 258px;
	height: 258px;
}
    </style>
</body>
<script src="{$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/pdd/js/jquery.min.js"></script>
<script src="{$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/pdd/js/lib.js"></script>
<link rel="stylesheet" href="{$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/pdd/css/swiper.css">
<script src="{$_W['siteroot']}addons/tiger_newhu/template/mobile/tbgoods/pdd/js/swiper.js"></script>
<script src="{$_W['siteroot']}addons/tiger_newhu/template/mobile/js/layer_mobile/layer.js"></script>
        <link href="{$_W['siteroot']}/addons/tiger_newhu/template/mobile/js/layer_mobile/need/layer.css" rel="stylesheet" />
<script>
    var swiper = new Swiper('.swiper-container', { 
        loop: true,
        autoplay: {
            delay: 2500,
            disableOnInteraction: false,
        },
        pagination: {
            el: '.swiper-pagination',
      },
    });
    
    //详情
    function getviewimg(itemid){
    	//alert(itemid);
    	$("#cententview").html("<p style='text-align:center;line-height:50px'>详情加载中！请稍后</p>")
    	$.ajax({
	            url:"{php echo $this->createMobileUrl('pddviewimg')}",
	              type:'post',
	              data:{
	              	itemid:itemid,
	              },
	            dataType:"json", 
	            success: function (data) {
	            	$("#cententview").html(data.data)
	             console.log(data);
	            }
	     	});
	     	console.log(1111333);
    }
    getviewimg("{$views['itemid']}");
    //商品海报
    
        $("#fullimg_close,#mask").click(function(){
			$("#mask").fadeOut();
			$("#full_img").fadeOut();
			$("#cus_service_img").fadeOut();
		});
		
		$("#cus_service").click(function(){
			$("#mask").fadeIn();
			$("#cus_service_img").fadeIn();
		});

		$("#open_fullimg_btn").click(function(){//商品二维码	
			//alert(1111);
			if($('#rwmtp').html()!=""){
				$("#mask").fadeIn();
	            $("#full_img").fadeIn();
	            return false;
			}
		    layer.open({
			    type: 2
			    ,content: '正在为您生成图片,请稍后！'
			    ,time: 1000
			 });
			 var code_img_src='';
			$.ajax({
	            url:"{php echo $this->createMobileUrl('getewm')}",
	              type:'post',
	              data:{
	              	url:encodeURIComponent("{$views['url1']}"),
	              },
	            dataType:"json", 
	            success: function (data) {
	             code_img_src=data;	 
	             canvasApp(code_img_src);
	             //console.log(code_img_src);
	            }
	     	});
		    
		});

		function canvasApp(code_img_src) {	
                var is_agent = window.localStorage.getItem('is_agent') || 0;
                var p_id = window.localStorage.getItem('adzone_pname') || '';
          
                var canvas = document.getElementById('sharecanvas');
                var ctx = canvas.getContext('2d');   		        
                ctx.fillStyle = "#fff";  
                canvas.width = 640;
                canvas.height = 896; 
                var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                for(var i = 0; i < imageData.data.length; i += 4) {
                    // 当该像素是透明的，则设置成白色
                if(imageData.data[i + 3] == 0) {
                    imageData.data[i] = 255;
                    imageData.data[i + 1] = 255;
                    imageData.data[i + 2] = 255;
                    imageData.data[i + 3] = 255; 
                    }
                }
                ctx.putImageData(imageData, 0, 0);

            /*商品主图*/                
            var bj_img = new Image();
            bj_img.setAttribute('crossOrigin','anonymous');
            //bj_img.src = "{$_W['siteroot']}addons/tiger_newhu/hb/bj.jpg"; 
            bj_img.src = "/addons/tiger_newhu/hb/bj1.jpg"; 
            bj_img.onload = function(){
			    ctx.drawImage(bj_img, 0, 0, canvas.width, canvas.height);
			    var item_img = new Image();
                item_img.setAttribute('crossOrigin','anonymous');
                item_img.src = "{$views['itempic5'][0]}";
                //'https://img.alicdn.com/bao/uploaded/i2/357274591/TB1anbaeMvD8KJjSsplXXaIEFXa_!!0-item_pic.jpg'
                item_img.onload = function(){
					ctx.drawImage(item_img, 0, 0, canvas.width, canvas.width);
					
					/*二维码*/
					var code_img = new Image();
					code_img.setAttribute('crossOrigin','anonymous');
					//code_img.src = "{$_W['siteroot']}app/index.php?i={$_W['uniacid']}&c=entry&do=images&m=tiger_newhu&url="+ encodeURIComponent('http://qr.liantu.com/api.php?m=10&w=200&text='+encodeURIComponent(1111));
					code_img.src=code_img_src;
//					console.log(code_img.src);
//	
					code_img.onload = function() {
				    ctx.drawImage(code_img, canvas.width - 205,canvas.width + 30,175, 175);		  
				    
				    /*图标*/
					var tb_img = new Image();
					tb_img.setAttribute('crossOrigin','anonymous');
					tb_img.src="/addons/tiger_newhu/template/mobile/tbgoods/pdd/images/pdd.png";
//	
					tb_img.onload = function() {
				    ctx.drawImage(tb_img, canvas.width -620,canvas.width +28,35, 35);		

						console.log(code_img);
						/*商品标题*/
						var str = "                    {$views['itemtitle']}";
						ctx.fillStyle='#605761';
						ctx.lineWidth=1; 
						ctx.textAlign = 'left';
						ctx.textBaseline = "top";
						ctx.font = '24px 微软雅黑';
						var lineWidth = 0;
						var canvasWidth = canvas.width - 60;//计算canvas的宽度
						var initHeight= canvas.width + 30;//绘制字体距离canvas顶部初始的高度
						var lastSubStrIndex= 0; //每次开始截取的字符串的索引
						for(var i = 0;i <= str.length; i++){ 
							lineWidth += ctx.measureText(str[i]).width; 
							if(lineWidth > canvasWidth - 230){ 
								ctx.fillText(str.substring(lastSubStrIndex,i),20,initHeight);//绘制截取部分
								initHeight += 40;//字体的高度
								lineWidth = 0;
								lastSubStrIndex = i;
							} 
							if(i == str.length - 1 ){
								ctx.fillText(str.substring(lastSubStrIndex,i + 1 ),20,initHeight);
							}
						}
						
						
						
						/*现价*/
						 var price = '现价：';
						ctx.fillStyle = '#aba0ac';
						ctx.textAlign = 'left';
						ctx.font = '20px 微软雅黑';
						ctx.textBaseline = "top";
						ctx.fillText(price,20,initHeight + 40);
						
						/*现价*/
						 var price = "¥ {$views['itemprice']}";
						ctx.fillStyle = '#aba0ac';
						ctx.textAlign = 'left';
						ctx.font = '20px Helvetica';
						ctx.textBaseline = "top";
						ctx.fillText(price,80,initHeight + 40);

						/*删除线*/
						ctx.strokeStyle = '#aba0ac';
						ctx.lineWidth = 1; // 改变线的粗细 
						ctx.moveTo(70, initHeight + 50); // 起始点 
						ctx.lineTo(140, initHeight + 50); // 第二点(如果是一条直线的话，就是终点) 
						ctx.stroke();

						/*在售标题*/
						var end_price_title = '券后价:';
						ctx.fillStyle = '#aba0ac';
						ctx.textAlign = 'left';
						ctx.font = '20px 微软雅黑';
						ctx.textBaseline = "top";
						ctx.fillText(end_price_title,120,initHeight +87);

						/*在售价格*/
						var end_price = "¥ {$views['itemendprice']}";
						ctx.fillStyle = '#FF4E12';
						ctx.textAlign = 'left';
						ctx.font = '36px Helvetica';
						ctx.textBaseline = "top";
						ctx.fillText(end_price,190,initHeight + 75);
				
						 /*秘券金额*/
						  var end_price = "{$views['couponmoney']}元";
						  ctx.fillStyle = '#FF4E12';
						  ctx.textAlign = 'left';
						  ctx.font = '20px Helvetica';
						  ctx.textBaseline = "top";
						  ctx.fillText(end_price,55,initHeight + 87);
						  
					
					    
						
						/*保存为图片*/
						var image = new Image();
						image.setAttribute('crossOrigin','anonymous');
						image.src = canvas.toDataURL("img/png");
			
						//$(".imgData").attr("background","white");
						//$(".imgData").attr("src",image.src);
						if(image.src){
							$("#layui-m-layer0").css("display","none");
						}
		                $("#mask").fadeIn();
				        $("#full_img").fadeIn();
//				        console.log("图片链接:"+image.src);
						$("#rwmtp").html("<img  src='"+image.src+"'>");

						
					}
					}
				}
           }

		}
//海报
  </script>
</html>